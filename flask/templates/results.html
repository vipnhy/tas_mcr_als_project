{% extends "base.html" %}

{% block title %}分析结果 - TAS MCR-ALS 分析平台{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- 结果概览 -->
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    分析结果
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6>基本信息</h6>
                        <p><strong>文件名:</strong> {{ session_info.filename }}</p>
                        <p><strong>会话ID:</strong> {{ session_info.session_id }}</p>
                        <p><strong>完成时间:</strong> {{ session_info.completion_time[:19] if session_info.completion_time else '未知' }}</p>
                    </div>
                    <div class="col-md-3">
                        <h6>数据信息</h6>
                        <p><strong>文件类型:</strong> {{ session_info.parameters.file_type }}</p>
                        <p><strong>波长范围:</strong> {{ session_info.parameters.wavelength_range[0] }} - {{ session_info.parameters.wavelength_range[1] }} nm</p>
                        <p><strong>时间延迟:</strong> {{ session_info.parameters.delay_range[0] }} - {{ session_info.parameters.delay_range[1] }} ps</p>
                    </div>
                    <div class="col-md-3">
                        <h6>分析参数</h6>
                        <p><strong>组分数量:</strong> {{ session_info.parameters.n_components }}</p>
                        <p><strong>最大迭代:</strong> {{ session_info.parameters.max_iter }}</p>
                        <p><strong>界面语言:</strong> {{ session_info.parameters.language }}</p>
                    </div>
                    <div class="col-md-3">
                        <h6>分析结果</h6>
                        <p><strong>状态:</strong> 
                            <span class="badge bg-success">已完成</span>
                        </p>
                        <p id="analysisResults">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            加载结果信息...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果文件 -->
        <div class="row">
            <!-- 图表文件 -->
            <div class="col-md-6">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-images me-2"></i>
                            分析图表
                        </h5>
                    </div>
                    <div class="card-body">
                        {% set image_files = result_files | selectattr('is_image') | list %}
                        {% if image_files %}
                            {% for file in image_files %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>{{ file.filename }}</strong>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary me-2" 
                                                    onclick="previewImage('{{ file.filename }}')">
                                                <i class="fas fa-eye me-1"></i>预览
                                            </button>
                                            <a href="{{ url_for('download_file', session_id=session_info.session_id, filename=file.filename) }}" 
                                               class="btn btn-sm btn-primary">
                                                <i class="fas fa-download me-1"></i>下载
                                            </a>
                                        </div>
                                    </div>
                                    <div class="text-muted small">
                                        大小: {{ "%.2f"|format(file.size / 1024) }} KB
                                    </div>
                                </div>
                                <hr>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">没有找到图表文件</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 数据文件 -->
            <div class="col-md-6">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-file-csv me-2"></i>
                            数据文件
                        </h5>
                    </div>
                    <div class="card-body">
                        {% set data_files = result_files | selectattr('is_data') | list %}
                        {% if data_files %}
                            {% for file in data_files %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>{{ file.filename }}</strong>
                                        <div>
                                            {% if file.filename.endswith('.csv') %}
                                                <button class="btn btn-sm btn-outline-info me-2" 
                                                        onclick="previewCSV('{{ file.filename }}')">
                                                    <i class="fas fa-table me-1"></i>预览
                                                </button>
                                            {% endif %}
                                            <a href="{{ url_for('download_file', session_id=session_info.session_id, filename=file.filename) }}" 
                                               class="btn btn-sm btn-success">
                                                <i class="fas fa-download me-1"></i>下载
                                            </a>
                                        </div>
                                    </div>
                                    <div class="text-muted small">
                                        大小: {{ "%.2f"|format(file.size / 1024) }} KB
                                    </div>
                                </div>
                                <hr>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">没有找到数据文件</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表预览区域 -->
        <div class="row" id="previewSection" style="display: none;">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="previewTitle">
                            <i class="fas fa-eye me-2"></i>
                            图表预览
                        </h5>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="closePreview()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="card-body text-center">
                        <img id="previewImage" src="" class="img-fluid" style="max-height: 600px;">
                        <div id="csvPreview" style="display: none; max-height: 400px; overflow: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body text-center">
                        <h5>下载选项</h5>
                        <div class="btn-group me-3" role="group">
                            <a href="{{ url_for('download_all_results', session_id=session_info.session_id) }}" 
                               class="btn btn-primary btn-lg">
                                <i class="fas fa-download me-2"></i>下载全部结果
                            </a>
                        </div>
                        
                        <div class="btn-group me-3" role="group">
                            <a href="{{ url_for('upload_file') }}" class="btn btn-outline-primary btn-lg">
                                <i class="fas fa-upload me-2"></i>分析新数据
                            </a>
                        </div>
                        
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('list_sessions') }}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-history me-2"></i>查看历史
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let sessionId = '{{ session_info.session_id }}';

// 页面加载完成后获取详细结果信息
document.addEventListener('DOMContentLoaded', function() {
    loadAnalysisResults();
});

// 加载分析结果信息
function loadAnalysisResults() {
    fetch(`/api/get_progress/${sessionId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.session_info) {
            const info = data.session_info;
            if (info.analysis_id) {
                document.getElementById('analysisResults').innerHTML = `
                    <strong>分析ID:</strong> ${info.analysis_id}<br>
                    <strong>状态:</strong> <span class="badge bg-success">已完成</span>
                `;
            }
        }
    })
    .catch(error => {
        console.error('加载结果信息失败:', error);
        document.getElementById('analysisResults').innerHTML = `
            <span class="text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                无法加载结果信息
            </span>
        `;
    });
}

// 预览图片
function previewImage(filename) {
    const imageUrl = `/download/${sessionId}/${filename}`;
    document.getElementById('previewImage').src = imageUrl;
    document.getElementById('previewTitle').innerHTML = `
        <i class="fas fa-eye me-2"></i>
        图表预览: ${filename}
    `;
    document.getElementById('previewImage').style.display = 'block';
    document.getElementById('csvPreview').style.display = 'none';
    document.getElementById('previewSection').style.display = 'block';
    
    // 滚动到预览区域
    document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
}

// 预览CSV文件
function previewCSV(filename) {
    const csvUrl = `/download/${sessionId}/${filename}`;
    
    fetch(csvUrl)
    .then(response => response.text())
    .then(csvText => {
        // 解析CSV并创建表格
        const lines = csvText.split('\n').slice(0, 20); // 只显示前20行
        const table = document.createElement('table');
        table.className = 'table table-striped table-sm';
        
        lines.forEach((line, index) => {
            if (line.trim()) {
                const row = table.insertRow();
                const cells = line.split(',');
                cells.forEach(cellText => {
                    const cell = row.insertCell();
                    cell.textContent = cellText.trim();
                    if (index === 0) {
                        cell.className = 'fw-bold';
                    }
                });
            }
        });
        
        document.getElementById('csvPreview').innerHTML = '';
        document.getElementById('csvPreview').appendChild(table);
        
        if (lines.length >= 20) {
            const note = document.createElement('p');
            note.className = 'text-muted small mt-2';
            note.textContent = '(仅显示前20行数据)';
            document.getElementById('csvPreview').appendChild(note);
        }
        
        document.getElementById('previewTitle').innerHTML = `
            <i class="fas fa-table me-2"></i>
            数据预览: ${filename}
        `;
        document.getElementById('previewImage').style.display = 'none';
        document.getElementById('csvPreview').style.display = 'block';
        document.getElementById('previewSection').style.display = 'block';
        
        // 滚动到预览区域
        document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
    })
    .catch(error => {
        console.error('预览CSV失败:', error);
        alert('无法预览此文件');
    });
}

// 关闭预览
function closePreview() {
    document.getElementById('previewSection').style.display = 'none';
}

// 添加键盘快捷键支持
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePreview();
    }
});
</script>

<style>
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

#previewImage {
    border-radius: 8px;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
}

.table-sm td {
    padding: 0.25rem;
    font-size: 0.875em;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>
{% endblock %}
